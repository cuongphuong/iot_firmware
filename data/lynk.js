let LOAD_DEVICE_PREFIX="L_LOAD",BUTTON_DEVICE_PREFIX="L_PRSS",SENSOR_DEVICE_PREFIX="L_SERS",wifiInfo={},glDeviceList=[];async function initialize(){document.querySelectorAll(".button-fixed1").forEach(e=>e.setAttribute("disabled","disabled")),document.querySelectorAll(".button-fixed2").forEach(e=>e.setAttribute("disabled","disabled"));var e=await fetch("/lynk/v2/get-wifi-info").then(e=>e.json());wifiInfo=e,fetch("/lynk/v2/get-device-list").then(e=>e.json()).then(e=>{glDeviceList=[...e],console.log("DeviceList: ",glDeviceList),dataSet(e),document.querySelectorAll(".button-fixed1").forEach(e=>e.removeAttribute("disabled")),document.querySelectorAll(".button-fixed2").forEach(e=>e.removeAttribute("disabled")),document.getElementById("scan-loadding").remove()}).catch(e=>{document.querySelectorAll(".button-fixed1").forEach(e=>e.removeAttribute("disabled")),document.querySelectorAll(".button-fixed2").forEach(e=>e.removeAttribute("disabled")),document.querySelector("#scan-loadding i").innerHTML="Tải lỗi, vui lòng thử lại"})}function registEventTable(){document.querySelectorAll(".cpg-expand-btn").forEach(e=>{e.addEventListener("click",function(){var e=this.closest("tr").getAttribute("data-id"),e=document.querySelectorAll(`.cpg-child[data-parent='${e}']`),t=!e[0].classList.contains("cpg-hidden");document.querySelectorAll(".cpg-child:not(.cpg-hidden)").forEach(e=>{e.classList.add("cpg-hidden")}),t||e.forEach(e=>e.classList.remove("cpg-hidden"))})})}async function getScanNetwork(){let e=0;for(fetch("/lynk/v2/start-scan-network",{method:"GET"}),await new Promise(e=>setTimeout(e,2e3));;){if(5==e){alert("Scan result failed, please try again.");break}var i=await fetchToCheckNetwork();if(null!=i.data){document.getElementById("scan-table-output-id").innerHTML="",document.getElementById("add-button-id").removeAttribute("disabled");let t=Array.from(document.querySelectorAll(".device")).map(e=>{e=e.querySelector(".added_device_name_clss");return e?e.innerText:null});i.data.forEach(e=>{t.includes(e.SSID)||(e.SSID.startsWith(LOAD_DEVICE_PREFIX)||e.SSID.startsWith(BUTTON_DEVICE_PREFIX)||e.SSID.startsWith(SENSOR_DEVICE_PREFIX))&&(e=`
            <tr>
              <td><input type="checkbox" name="add-checkbox" id="ck_${e.SSID}" data-name="${e.SSID}"></td>
              <td><label style="cursor: pointer" for="ck_${e.SSID}">${e.SSID}</label></td>
              <td>
                <input type="text" id="ipv4_${e.SSID}" style="width: 100px">
                <i style="cursor: pointer; text-decoration: underline;" class="fas fa-robot">auto</i>
              </td>
            </tr>`,document.getElementById("scan-table-output-id").innerHTML+=e)});break}await new Promise(e=>setTimeout(e,2e3)),e++}}async function fetchToCheckNetwork(){return fetch("/lynk/v2/get-scan-network",{method:"GET"}).then(e=>e.json())}async function addDeviceIntoStagedList(){document.getElementById("tab-selected").value;var e=document.querySelectorAll("input[name=add-checkbox]:checked");let t=await fetch("http://192.168.7.56/lynk/v2/model-data").then(e=>e.json());e.forEach(function(e){var e=e.getAttribute("data-name"),i=document.getElementById("ipv4_"+e).value;let d=parseDeviceString(e),n=t.find(e=>e.model==d.model);if(n){let t={deviceModel:d.model,deviceName:e,deviceNo:d.deviceNo,deviceType:d.type,gateway:wifiInfo.GATEWAY,ipAddress:i,subnetMark:wifiInfo.MASK,wifiName:wifiInfo.SSID,wifiPass:wifiInfo.PASS,hasNewDevice:!0,deviceState:[]};n.pin.forEach(e=>{t.deviceState.push({gpioPin:e,isSyncing:!1,lastExecutionTime:0,lastState:0,loadName:n.model+"-"+e,lynkPioPin:0,startTime:0,waningState:!1,warningNum:0})}),glDeviceList.push(t)}else alert("Model "+d.model+" không tìm thấy, bỏ qua thiết bị này!")}),dataSet(glDeviceList),closeModal("addableModal")}function cmdEditOnClick(e){let t=parseDeviceString(e);var i=glDeviceList.find(e=>e.deviceNo==t.deviceNo);document.getElementById("add_device_user").value=i.wifiName,document.getElementById("add_device_password").value=i.wifiPass,document.getElementById("add_device_sip").value=i.ipAddress,document.getElementById("add_device_gateway").value=i.gateway,document.getElementById("add_device_submark").value=i.subnetMark,document.getElementById("add_device_name").value=e,openModal("editableModal")}async function cmdDetailButtonOnClick(e,i){document.getElementById("view_device_info1").value="Loadding...",document.getElementById("view_virtual_pin_link1").value="0",document.getElementById("device_edit_id").value=e,document.getElementById("pinNo_edit_id").value=i;for(let t=0;t<glDeviceList.length;t++)if(glDeviceList[t].deviceNo==e)for(let e=0;e<glDeviceList[t].deviceState.length;e++)if(glDeviceList[t].deviceState[e].gpioPin==i){document.getElementById("view_virtual_pin_link1").value=glDeviceList[t].deviceState[e].lynkPioPin;break}openModal("detailButtonModal");var t=await fetch(`/lynk/v2/detail-pin?deviceNo=${e.trim()}&pinNo=`+i.trim()).then(e=>e.json());document.getElementById("view_device_info1").value=JSON.stringify(t,null,2)}async function cmdLoadDeviceOnClick(e,i){document.getElementById("view_device_info2").value="Loadding...",document.getElementById("view_virtual_pin_link2").value="0",document.getElementById("loadName_id2").value="",document.getElementById("device_edit_id").value=e,document.getElementById("pinNo_edit_id").value=i;for(let t=0;t<glDeviceList.length;t++)if(glDeviceList[t].deviceNo==e)for(let e=0;e<glDeviceList[t].deviceState.length;e++)if(glDeviceList[t].deviceState[e].gpioPin==i){document.getElementById("view_virtual_pin_link2").value=glDeviceList[t].deviceState[e].lynkPioPin,document.getElementById("loadName_id2").value=glDeviceList[t].deviceState[e].loadName;break}openModal("detailLoadDeviceModal");var t=await fetch(`/lynk/v2/detail-pin?deviceNo=${e.trim()}&pinNo=`+i.trim()).then(e=>e.json());document.getElementById("view_device_info2").value=JSON.stringify(t,null,2)}function cmdCompleteModalUpd(i){var e=document.getElementById("device_edit_id").value,d=document.getElementById("pinNo_edit_id").value;closeModal("detailButtonModal"),closeModal("detailLoadDeviceModal");for(let t=0;t<glDeviceList.length;t++)if(glDeviceList[t].deviceNo==e)for(let e=0;e<glDeviceList[t].deviceState.length;e++)glDeviceList[t].deviceState[e].gpioPin==d&&(1==i&&(glDeviceList[t].deviceState[e].lynkPioPin=Number(document.getElementById("view_virtual_pin_link1").value)),2==i)&&(glDeviceList[t].deviceState[e].lynkPioPin=Number(document.getElementById("view_virtual_pin_link2").value),glDeviceList[t].deviceState[e].loadName=document.getElementById("loadName_id2").value)}function cmdDeleteOnClick(e){if(1==confirm(`Do you want to delete "${e}"`)){let t=parseDeviceString(e);glDeviceList=glDeviceList.filter(e=>e.deviceNo!==t.deviceNo),document.getElementById("dv_"+e).remove()}}function saveDeviceList(){if(1==confirm("Do you want to save")){let t=[];glDeviceList.forEach(e=>{t.push({deviceNo:e.deviceNo,deviceModel:e.deviceModel,deviceName:e.deviceName,deviceType:e.deviceType,gateway:e.gateway,ipAddress:e.ipAddress,subnetMark:e.subnetMark,wifiName:e.wifiName,wifiPass:e.wifiPass,deviceState:e.deviceState})}),fetch("/api/save-device-list",{method:"POST",body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{"success"==e.msg?alert("Lưu thông tin thành công!"):alert(e.msg)}).catch(e=>{console.error(e)})}}function openTab(e,t,i){for(var d,n=document.getElementsByClassName("tab"),a=0;a<n.length;a++)n[a].style.display="none";for(d=document.getElementsByClassName("tablinks"),a=0;a<d.length;a++)d[a].className=d[a].className.replace(" active","");document.getElementById(t).style.display="block",document.getElementById("tab-selected").value=t,i?i.className+=" active":e.currentTarget.className+=" active"}function openModal(e){"addableModal"===e&&(document.getElementById("scan-table-output-id").innerHTML=`
            <tr id="scan-loadding">
              <td colspan="3"><i style="cursor: pointer;" class="fas fa-robot">Đang quét, vui lòng chờ...</i></td>
            </tr>`,document.getElementById("add-button-id").setAttribute("disabled","disabled"),getScanNetwork()),document.getElementById(e).style.display="block"}function closeModal(e){document.getElementById(e).style.display="none"}function parseDeviceString(e){var t=e.match(/^L_(LOAD|PRSS|SERS)_(LD\d{3}|PR\d{3}|SR\d{3})_ID(\d{6})$/);if(t)return{type:t[1],model:t[2],deviceNo:Number(t[3])};alert("Invalid device string format: "+e)}function dataSet(e){document.getElementById("added_device_table_tab1").innerHTML="",document.getElementById("added_device_table_tab2").innerHTML="",document.getElementById("added_device_table_tab3").innerHTML="",e.forEach(function(t){let i=`
                <tr class="device cpg-parent cpg-tr ${t.hasNewDevice?"new_device":""}" id="dv_${t.deviceName}" data-id="${t.deviceNo}">
                  <td  style="cursor: pointer;" class="added_device_name_clss cpg-expand-btn cpg-td">${t.deviceName}</td>
                  <td class="added_device_wifiname" style="display: none;">${t.wifiName}</td>
                  <td class="added_device_password" style="display: none;">${t.wifiPass}</td>
                  <td class="added_device_ipv4">${t.ipAddress}</td>
                  <td class="added_device_gateway" style="display: none;">${t.gateway}</td>
                  <td class="added_device_subnetmask" style="display: none;">${t.subnetMark}</td>
                  <td style="position: relative">
                    <button class="btn-table btn-left" onclick="cmdDeleteOnClick('${t.deviceName}')" ${"0.0.0.0"==t.ipAddress?"disabled":""}>“␡”</button>
                    <button class="btn-table btn-right" onclick="cmdEditOnClick('${t.deviceName}')" ${"0.0.0.0"==t.ipAddress?"disabled":""}>“✎”</button>
                  </td>
                </tr>`;t.deviceState.forEach(function(e){e=`<tr onclick="${"PRSS"===t.deviceType?`cmdDetailButtonOnClick('${t.deviceNo}', '${e.gpioPin}')`:"LOAD"===t.deviceType?`cmdLoadDeviceOnClick('${t.deviceNo}', '${e.gpioPin}')`:""}" class="cpg-child cpg-hidden cpg-tr" data-parent="${t.deviceNo}">
                                    <td class="cpg-td" colspan="3">${t.deviceModel+" (PIN: "+e.gpioPin+") “✎” "}</td>
                                  </tr>`;i+=e}),t.deviceName.startsWith(LOAD_DEVICE_PREFIX)&&(document.getElementById("added_device_table_tab1").innerHTML+=i),t.deviceName.startsWith(BUTTON_DEVICE_PREFIX)&&(document.getElementById("added_device_table_tab2").innerHTML+=i),t.deviceName.startsWith(SENSOR_DEVICE_PREFIX)&&(document.getElementById("added_device_table_tab3").innerHTML+=i)}),registEventTable()}function completeEdit(){var t=parseDeviceString(document.getElementById("add_device_name").value);for(let e=0;e<glDeviceList.length;e++)glDeviceList[e].deviceNo==t.deviceNo&&(glDeviceList[e].gateway=document.getElementById("add_device_gateway").value,glDeviceList[e].ipAddress=document.getElementById("add_device_sip").value,glDeviceList[e].subnetMark=document.getElementById("add_device_submark").value,glDeviceList[e].wifiName=document.getElementById("add_device_user").value,glDeviceList[e].wifiPass=document.getElementById("add_device_password").value);closeModal("editableModal")}function deleteAllDevice(){if(1==confirm("Xoá tất cả?")){let t=[];glDeviceList.forEach(e=>{"0.0.0.0"!=e.ipAddress?document.getElementById("dv_"+e.deviceName).remove():t.push(e)}),glDeviceList=t}}document.addEventListener("DOMContentLoaded",function(e){document.getElementById("tab1").style.display="block",initialize()});